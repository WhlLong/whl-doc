# Eureka简介

Eureka分为Server和Client两部分,Server作为服务的注册中心，Client会向Server注册自己的服务。Eureka主要用于分布式系统中的服务治理。 Client可以通过调用Server的API来实现服务注册、心跳维护、服务列表获取以及服务下线等操作。

下面介绍一下Eureka在进行服务治理的时候涉及到的一些概念:

**服务注册**：Eureka Client会通过发送REST请求的方式向EurekaServer注册自己的服务，提供自身的元数据，比如ip地址、端口、运行状况指标的url、主页地址等信息。EurekaServer接收到注册请求后，就会把这些元数据信息存储在一个双层的Map中。

**服务续约**：在服务注册后，EurekaClient会维护一个心跳来持续通知EurekaServer，说明服务一直处于可用状态，防止被剔除,默认的情况下会每隔30秒发送一次心跳来进行服务续约。

**获取服务**：服务消费者（EurekaClient）在启动的时候，会发送一个REST请求给EurekaServer，获取上面注册的服务清单，并且缓存在EurekaClient本地，默认缓存30秒。同时，为了性能考虑，Eureka Server也会维护一份只读的服务清单缓存，该缓存每隔30秒更新一次。

**服务调用**：服务消费者在获取到服务清单后，就可以根据清单中的服务列表信息，查找到其他服务的地址，从而进行远程调用。Eureka有Region和Zone的概念，一个Region可以包含多个Zone，在进行服务调用时，优先访问处于同一个Zone中的服务提供者。

**服务同步**：EurekaServer之间会互相进行注册，构建EurekaServer集群，不同EurekaServer之间会进行服务同步，用来保证服务信息的一致性。

**服务下线**：当EurekaClient需要关闭或重启时，就不希望在这个时间段内再有请求进来，所以，就需要提前先发送REST请求给EurekaServer，告诉EurekaServer自己要下线了，EurekaServer在收到请求后，就会把该服务状态置为下线（DOWN），并把该下线事件传播出去。

**服务剔除**：有时候，服务实例可能会因为网络故障等原因导致不能提供服务，而此时该实例也没有发送请求给EurekaServer来进行服务下线，所以，还需要有服务剔除的机制。EurekaServer在启动的时候会创建一个定时任务，每隔一段时间（默认60秒），从当前服务清单中把超时没有续约（默认90秒）的服务剔除。

**自我保护**：既然EurekaServer会定时剔除超时没有续约的服务，那就有可能出现一种场景，网络一段时间内发生了异常，所有的服务都没能够进行续约，EurekaServer就把所有的服务都剔除了，这样显然不太合理。所以，就有了自我保护机制，当短时间内，统计续约失败的比例，如果达到一定阈值，则会触发自我保护的机制，在该机制下，EurekaServer不会剔除任何的微服务，等到正常后，再退出自我保护机制。

上面这些概念基本上可以说是代表了Eureka进行服务治理时的全过程。

> 1. 一个新的EurekaClient实例启动以后需要向EurekaServer注册自己的服务，并且要在Client和Server之间维持一个心跳，目的是告诉Server当前Client处于可用状态，除此之外还要从EurekaServer拉取服务注册表数据，这些数据被缓存到本地等待需要访问其他的服务实例时使用。
> 2. 当EurekaClient需要下线时，需要调用Server的API告诉EurekaServer，这是服务的下线操作。
> 3. EurekaServer相互之间会互相注册，形成EurekaServer集群。服务实例被注册到EurekaServer，或者服务实例发送了下线请求。集群之间的EurekaServer实例会进行服务数据同步来保证服务信息的一致性。
> 4. 如果服务下线了，却没有调用EurekaServer的API告知下线行为，比如出现宕机事件，已下线的服务实例依然存在于EurekaServer的服务列表中，这样其他的服务可能拿到已经下线的服务的信息。为了解决这个问题，EurekaServer提供了服务剔除机制，EurekaServer会在启动的时候创建一个定时任务，每隔六十秒进行一次检测，将服务列表中超时没有进行心跳操作的服务剔除。超时时间默认是90秒。
> 5. Eureka的服务剔除机制解决了无效服务剔除的问题，但是它也带来一个新的问题，那就是当遇到网络故障时，可能所有的服务都没有能够进行续约，如果这时候EurekaServer将所有的服务都剔除了，显然也是不太合理的。为了解决这个问题，EurekaServer内部增加了一个自我保护机制，在该机制下，EurekaServer会统计一定时间的心跳超时比例，如果在指定的时间范围内超时的服务实力比例过高，就会触发自我保护机制，自我保护机制被触发以后，将不会再提出任何实例，直到超时比例达到正常范围。